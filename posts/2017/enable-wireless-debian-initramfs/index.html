<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta content="debian,linux,barcelona,business,law,tax" name=keywords>
<meta content="Marc Fargas" name=author>
<meta property="og:title" content="Enable Wireless networks in Debian Initramfs - marcfargas.com">
<meta property="og:url" content="https://www.marcfargas.com/posts/2017/enable-wireless-debian-initramfs/">
<meta property="og:description" content="Personal blog of Marc Fargas">
<meta property="og:type" content="website">
<title>Enable Wireless networks in Debian Initramfs | marcfargas.com</title>
<script type=text/x-mathjax-config>
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>
<link rel=stylesheet href=https://www.marcfargas.com/css/style.css>
<link rel="shortcut icon" href=https://www.marcfargas.com/favicon.ico>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/solarized-light.min.css>
</head>
<body>
<section class=section>
<div class=container>
<nav class=nav>
<div class=nav-left>
<a class=nav-item href=https://www.marcfargas.com><h1 class="title is-4">marcfargas.com</h1></a>
</div>
<div class=nav-right>
<nav class="nav-item level is-mobile">
<a class=level-item href=https://github.com/telenieko target=_blank>
<span class=icon>
<i class="fa fa-github"></i>
</span>
</a>
<a class=level-item href=https://twitter.com/telenieko target=_blank>
<span class=icon>
<i class="fa fa-twitter"></i>
</span>
</a>
<a class=level-item href=https://linkedin.com/in/marc-fargas-58a4307 target=_blank>
<span class=icon>
<i class="fa fa-linkedin-square"></i>
</span>
</a>
<a class=level-item href=/index.xml target=_blank>
<span class=icon>
<i class="fa fa-rss"></i>
</span>
</a>
</nav>
</div>
</nav>
</div>
</section>
<section class=section>
<div class=container>
<h1 class=title>Enable Wireless networks in Debian Initramfs</h1>
<h2 class="subtitle is-5">December 7, 2017 by Marc Fargas</h2>
<div class=tags>
<a class="button is-link" href=/tags/network>network</a>
<a class="button is-link" href=/tags/linux>linux</a>
</div>
<div class=content>
<blockquote>
<p><strong>Initramfs is</strong> a very tiny environment in which your Linux system boots in order to do a lot of initialisation magic <em>before loading your system</em>.
The most common use case is to mount the root filesystem, like when it’s encrypted and you need to type a passphrase to mount it. Or if fsck needs to run on an unclean root filesystem.
Basically anything that goes <em>before</em> mounting the root filesystem and,
after that, before launching INIT (you can read more in the <a href=https://wiki.debian.org/initramfs title="Debian Wiki on initramfs">Debian Wiki</a>).</p>
</blockquote>
<p>There are scenarios in which you need the network available at this very preliminary state of the system boot. Doing that over wired ethernet is easy (as long as you don’t need authentication on the wire) with the <code>ip=</code> kernel parameter (<a href=https://www.kernel.org/doc/Documentation/filesystems/nfs/nfsroot.txt title="Mounting the root filesystem via NFS (nfsroot) -- which documents the ip parameter">see here the documentation of the ip= parameter</a>). Wireless connectivity is a whole different issue, WPA needs a helper program (<code>wpa_supplicant</code>), network configuration and, most likely, firmware files.</p>
<p>So, lets find out how can we get a wireless connection up and running on initramfs to do something useful there (in a later post: unattended boot with an encrypted rootfs).</p>
<p>A few warnings:</p>
<ul>
<li>I assume you know how to move around on the console, really.</li>
<li>If you screw up you might end up on an emergency shell or event with an unbootable system.</li>
<li>This solution kills <code>wpa_supplicant</code> at the last stage of init so the underlying system can take over the wireless connection (ie: NetworkManager) so, be sure that whatever you attempt to achieve can live with that network interruption.</li>
<li>Make sure you have a keyboard and display (or a serial console). <strong>Do not</strong> attempt to do this on a headless system.</li>
</ul>
<p>This has been tested on:</p>
<ul>
<li>Debian Stretch</li>
<li>Intel Corporation Wireless 7260 AC</li>
<li>WPA2 (AP is a Time Capsule)</li>
</ul>
<h2 id=initramfs-tools>initramfs-tools</h2>
<p>The Debian system utilises what is known as <code>initramfs-tools</code> to build the initramfs for the installed kernel images. A command comes with it: <code>update-initramfs</code> which updates/creates suchs images.
This tools is highly extendable (in fact, lots of packages extend it) by the end-user in the folder <code>/etc/initramfs-tools/</code> where hooks and scripts can be placed in order to <strong>customize the image build and/or the boot processes</strong>.
A very good place to start would be <code>man initramfs-tools</code> for our purpose today: the SCRIPTS section.</p>
<h2 id=what-we-need-initramfs-tools-to-do-for-us>What we need initramfs-tools to do for us</h2>
<ul>
<li>Add our wireless modules and firmware to the initramfs</li>
<li>Copy our dependencies to the image (<code>wpa_supplicant</code>, <code>wpa_cli</code>, <code>wpa_supplicant.conf</code> and its libraries)</li>
<li>Start <code>wpa_supplicant</code> to connect to the network</li>
<li>Setup networking (ip, etc)</li>
<li>Hold the boot process until the network is up or a timeout occurs</li>
<li>Kill <code>wpa_supplicant</code> before booting the underlying system to not conflict with whatever is there expecting full control of the network interface (aka: NetworkManager)</li>
</ul>
<p>That sounds easy.</p>
<h3 id=custom-hook>Custom hook</h3>
<p>We will use a hook to do the first two steps, note that for the modules part you can just type the module name in <code>/etc/initramfs-tools/modules</code> and it should work. We do it in the hook just to keep everything together.</p>
<p>This goes into <code>/etc/initramfs-tools/hooks/enable-wireless</code>, make sure to put
the right modules on the <code>manual_add_modules</code> line.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># !/bin/sh</span>
<span class=nb>set</span> -e
<span class=nv>PREREQ</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
prereqs<span class=o>()</span>
<span class=o>{</span>
    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PREREQ</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=o>}</span>
<span class=k>case</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>1</span><span class=si>}</span><span class=s2>&#34;</span> in
    prereqs<span class=o>)</span>
        prereqs
        <span class=nb>exit</span> <span class=m>0</span>
        <span class=p>;;</span>
<span class=k>esac</span>

. /usr/share/initramfs-tools/hook-functions

<span class=c1># CHANGE HERE for your correct modules.</span>
manual_add_modules iwlwifi iwlmvm
copy_exec /sbin/wpa_supplicant
copy_exec /sbin/wpa_cli
copy_file config /etc/initramfs-tools/wpa_supplicant.conf /etc/wpa_supplicant.conf
</code></pre></div><p>Pretty straighforward, the upper half is boilerplate as required by initramfs-tools, see the manpage for more. The rest is quite readable: add the modules (it will also add the firmwares), copy wpa* stuff, copy the configuration.</p>
<p>Now, <code>wpa_supplicant.conf</code> is unique to you, as always, <code>man wpa_supplicant.conf</code> is your friend, and here is an example:</p>
<pre><code># Sample /etc/initramfs-tools/wpa_supplicant.conf
# note that this is independent of the system /etc/wpa_supplicant.conf (if any)
# only add the network you need at boot time. **And keep the ctrl_interface** !!
ctrl_interface=/tmp/wpa_supplicant

network={
    ssid=&quot;MyNetwork&quot;
    scan_ssid=1
    psk=&quot;network passphrase&quot;
    key_mgmt=WPA-PSK
}
</code></pre><h3 id=connection-script-init-premount>Connection script (init-premount)</h3>
<p>Now, we need the system to startup the supplicant, connect and go on. This
can&rsquo;t be done at the init-top stage because not even the kernel modules are
available by then, to init-premount looks fine. Problem? Whatever the reason
you are reading this, most likely it also happens in init-premount
(mandos-client, cryptsetup, &mldr;) and initramfs-tools comes with this warning
on <a href=https://manpages.debian.org/jessie/initramfs-tools/initramfs-tools.8.en.html title="initramfs-tools manpage">the manpage</a>:</p>
<blockquote>
<p>No guarantees are made as to the order in which the different scripts are executed unless the prereqs are setup in the script.</p>
</blockquote>
<p>So&mldr; dirty hack is to assume alphabetical order of execution and put &ldquo;a_&rdquo; in front of the script. It works, for now.</p>
<p>This goes into `<code>/etc/initramfs-tools/scripts/init-premount/a_enable_wireless</code>, you need to change the <code>INTERFACE=</code> and, maybe, the <code>AUTH_LIMIT</code> one (the timeout):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/sh
</span><span class=cp></span><span class=nv>PREREQ</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
prereqs<span class=o>()</span>
<span class=o>{</span>
    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$PREREQ</span><span class=s2>&#34;</span>
<span class=o>}</span>

<span class=k>case</span> <span class=nv>$1</span> in
prereqs<span class=o>)</span>
    prereqs
    <span class=nb>exit</span> <span class=m>0</span>
    <span class=p>;;</span>
<span class=k>esac</span>

. /scripts/functions

<span class=nv>AUTH_LIMIT</span><span class=o>=</span><span class=m>30</span>
<span class=nv>INTERFACE</span><span class=o>=</span><span class=s2>&#34;wlp5s0&#34;</span>
<span class=nb>alias</span> <span class=nv>WPACLI</span><span class=o>=</span><span class=s2>&#34;/sbin/wpa_cli -p/tmp/wpa_supplicant -i</span><span class=nv>$INTERFACE</span><span class=s2> &#34;</span>

log_begin_msg <span class=s2>&#34;Starting WLAN connection&#34;</span>
/sbin/wpa_supplicant  -i<span class=nv>$INTERFACE</span> -c/etc/wpa_supplicant.conf -P/run/initram-wpa_supplicant.pid -B -f /tmp/wpa_supplicant.log

<span class=c1># Wait for AUTH_LIMIT seconds, then check the status</span>
<span class=nv>limit</span><span class=o>=</span><span class=si>${</span><span class=nv>AUTH_LIMIT</span><span class=si>}</span>

<span class=nb>echo</span> -n <span class=s2>&#34;Waiting for connection (max </span><span class=si>${</span><span class=nv>AUTH_LIMIT</span><span class=si>}</span><span class=s2> seconds)&#34;</span>
<span class=k>while</span> <span class=o>[</span> <span class=nv>$limit</span> -ge <span class=m>0</span> -a <span class=sb>`</span>WPACLI status <span class=p>|</span> grep wpa_state<span class=sb>`</span> !<span class=o>=</span> <span class=s2>&#34;wpa_state=COMPLETED&#34;</span> <span class=o>]</span>
<span class=k>do</span>
    sleep <span class=m>1</span>
    <span class=nb>echo</span> -n <span class=s2>&#34;.&#34;</span>
    <span class=nv>limit</span><span class=o>=</span><span class=sb>`</span>expr <span class=nv>$limit</span> - 1<span class=sb>`</span>
<span class=k>done</span>
<span class=nb>echo</span> <span class=s2>&#34;&#34;</span>

<span class=k>if</span> <span class=o>[</span> <span class=sb>`</span>WPACLI status <span class=p>|</span> grep wpa_state<span class=sb>`</span> !<span class=o>=</span> <span class=s2>&#34;wpa_state=COMPLETED&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
  <span class=nv>ONLINE</span><span class=o>=</span><span class=m>0</span>
  log_failure_msg <span class=s2>&#34;WLAN offline after timeout&#34;</span>
  panic
<span class=k>else</span>
  <span class=nv>ONLINE</span><span class=o>=</span><span class=m>1</span>
  log_success_msg <span class=s2>&#34;WLAN online&#34;</span>
<span class=k>fi</span>

configure_networking
</code></pre></div><h3 id=kill-when-done>Kill when done</h3>
<p>Last, but not least, `<code>/etc/initramfs-tools/scripts/local-bottom/kill_wireless</code>
should contain:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/sh
</span><span class=cp></span><span class=nv>PREREQ</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
prereqs<span class=o>()</span>
<span class=o>{</span>
    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$PREREQ</span><span class=s2>&#34;</span>
<span class=o>}</span>

<span class=k>case</span> <span class=nv>$1</span> in
prereqs<span class=o>)</span>
    prereqs
    <span class=nb>exit</span> <span class=m>0</span>
    <span class=p>;;</span>
<span class=k>esac</span>

<span class=nb>echo</span> <span class=s2>&#34;Killing wpa_supplicant so the system takes over later.&#34;</span>
<span class=nb>kill</span> <span class=sb>`</span>cat /run/initram-wpa_supplicant.pid<span class=sb>`</span>
</code></pre></div><h2 id=final-touches>Final touches</h2>
<p>You may have noticed we use the provided <code>configure_networking</code> function, it
relies on you passing the proper <code>ip=</code>kernel parameter, so better supply it,
for GRUB just setup the <code>GRUB_CMDLINE_LINUX</code> in <code>/etc/default/grub</code> like:
<code>GRUB_CMDLINE_LINUX="ip=:::::wlp5s0:on panic=10"</code>
(<a href=https://www.kernel.org/doc/Documentation/filesystems/nfs/nfsroot.txt title="Mounting the root filesystem via NFS (nfsroot) -- which documents the ip parameter">see here the documentation of the ip= parameter</a>). The <code>panic=10</code> makes the system reboot if something goes wrong (like network failure), when testing you might prefer <code>break=premount</code> or some other options, see the <a href=https://www.kernel.org/doc/Documentation/filesystems/nfs/nfsroot.txt title="Mounting the root filesystem via NFS (nfsroot) -- which documents the ip parameter">initramfs-tools manpage</a><a href=https://manpages.debian.org/jessie/initramfs-tools/initramfs-tools.8.en.html title="initramfs-tools manpage">5</a> or <a href=https://wiki.debian.org/InitramfsDebug title="Debian Wiki on InitramfsDebug">the Debian wiki InitramfsDebug page</a></p>
<p>Make the scripts executable, and, finally, rebuild initramfs and update-grub:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>chmod +x /etc/initramfs-tools/scripts/local-bottom/kill_wireless
chmod +x /etc/initramfs-tools/scripts/init-premount/a_enable_wireless
chmod +x /etc/initramfs-tools/hooks/enable-wireless

update-initramfs -k all -u
update-grub
</code></pre></div><p>And&mldr; reboot. I suggest you boot with <code>break=bottom</code>so you can check things work as expected (i.e with <code>ip link</code> and <code>ip addr</code>).</p>
</div>
<div class=nav-left>
<a class=nav-item href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.marcfargas.com%2fposts%2f2017%2fenable-wireless-debian-initramfs%2f" title="Share on Facebook" target=_blank><span class="fa fa-facebook fa-2x" aria-hidden=true></span></a>
<a class=nav-item href="https://plus.google.com/share?url=https%3a%2f%2fwww.marcfargas.com%2fposts%2f2017%2fenable-wireless-debian-initramfs%2f" title="Share on Google+" target=_blank><span class="fa fa-google-plus fa-2x" aria-hidden=true></span></a>
<a class=nav-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.marcfargas.com%2fposts%2f2017%2fenable-wireless-debian-initramfs%2f" title="Share on LinkedIn" target=_blank><span class="fa fa-linkedin fa-2x" aria-hidden=true></span></a>
<a class=nav-item href="https://twitter.com/home?status=Enable%20Wireless%20networks%20in%20Debian%20Initramfs - https%3a%2f%2fwww.marcfargas.com%2fposts%2f2017%2fenable-wireless-debian-initramfs%2f" title="Tweet this" target=_blank><span class="fa fa-twitter fa-2x"></span></a>
<a class=nav-item href="http://www.reddit.com/submit?url=https%3a%2f%2fwww.marcfargas.com%2fposts%2f2017%2fenable-wireless-debian-initramfs%2f&title=Enable%20Wireless%20networks%20in%20Debian%20Initramfs" title="Share on Reddit" target=_blank><span class="fa fa-reddit-alien fa-2x" aria-hidden=true></span></a>
</div>
</div>
</section>
<section class=section>
<div class=container>
<aside><div id=disqus_thread></div></aside>
<script type=text/javascript>var disqus_shortname='marcfargas-com';(function(){var a=document.createElement('script');a.type='text/javascript',a.async=!0,a.src='//'+disqus_shortname+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript>
</div>
</section>
<section class=section>
<div class="container has-text-centered">
<p>&copy; 2021 | Follow on <a href=https://twitter.com/telenieko target=_blank>Twitter</a> | <a href=https://github.com/mgjohansen/hucore.git target=_blank>Hucore theme</a> & <a href=http://gohugo.io target=_blank>Hugo</a> ♥</p>
</div>
</section>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js integrity="sha256-+bhVTaRmJ/c07eV80nU8gD2cBBF0rYkf1txqXlrbvb0=" crossorigin=anonymous></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/go.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/python.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/bash.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/kotlin.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/java.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>