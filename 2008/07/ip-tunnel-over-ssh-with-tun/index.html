<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta content="debian,linux,barcelona,business,law,tax" name=keywords>
<meta content="Marc Fargas" name=author>
<meta property="og:title" content="Ip Tunnel Over Ssh With Tun - marcfargas.com">
<meta property="og:url" content="https://www.marcfargas.com/2008/07/ip-tunnel-over-ssh-with-tun/">
<meta property="og:description" content="Personal blog of Marc Fargas">
<meta property="og:type" content="website">
<title>Ip Tunnel Over Ssh With Tun | marcfargas.com</title>
<script type=text/x-mathjax-config>
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>
<link rel=stylesheet href=https://www.marcfargas.com/css/style.css>
<link rel="shortcut icon" href=https://www.marcfargas.com/favicon.ico>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous>
<link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/solarized-light.min.css>
</head>
<body>
<section class=section>
<div class=container>
<nav class=nav>
<div class=nav-left>
<a class=nav-item href=https://www.marcfargas.com><h1 class="title is-4">marcfargas.com</h1></a>
</div>
<div class=nav-right>
<nav class="nav-item level is-mobile">
<a class=level-item href=https://github.com/telenieko target=_blank>
<span class=icon>
<i class="fa fa-github"></i>
</span>
</a>
<a class=level-item href=https://twitter.com/telenieko target=_blank>
<span class=icon>
<i class="fa fa-twitter"></i>
</span>
</a>
<a class=level-item href=https://linkedin.com/in/marc-fargas-58a4307 target=_blank>
<span class=icon>
<i class="fa fa-linkedin-square"></i>
</span>
</a>
<a class=level-item href=/index.xml target=_blank>
<span class=icon>
<i class="fa fa-rss"></i>
</span>
</a>
</nav>
</div>
</nav>
</div>
</section>
<section class=section>
<div class=container>
<h1 class=title>Ip Tunnel Over Ssh With Tun</h1>
<h2 class="subtitle is-5">July 24, 2008 by Marc Fargas</h2>
<div class=tags>
<a class="button is-link" href=/tags/linux>linux</a>
<a class="button is-link" href=/tags/network>network</a>
</div>
<div class=content>
<p>Today I had some connection problems in one of our offices, so I needed to connect in some alternative way. A good moment for experimenting&mldr; The alternative connection was my laptop acting as a router connected with my mobile phone via bluetooth.</p>
<p>The problem&rsquo;s come with the VPN connections, IPSec is nice, but you can hate it on lots of things&mldr; i.e. all tunnels are setup using static ip addresses so in order to use the alternate connection (dynamic IP) I need to change the ipsec config of the other offices.</p>
<p>So today I wanted to try something new, tunneling ip traffic from one network to another over an ssh connection. And it works, Gentoo&rsquo;s wiki has some information on the subject: <a href=https://web.archive.org/web/20090328151009/http://gentoo-wiki.com/HOWTO_VPN_over_SSH_and_tun title="Gentoo Wiki">here</a></p>
<p>In brief, you need to, on the server:</p>
<p>Add &ldquo;<code>PermitTunnel yes</code>&rdquo; to <code>/etc/ssh/sshd_config</code>
Now, on the client it&rsquo;s as easy as to run ssh with some parameters, my script for launching it is:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/sh
</span><span class=cp></span><span class=nv>HOST</span><span class=o>=</span>REMOTE_PARTY_ADDRESS
<span class=nv>HOST_PORT</span><span class=o>=</span><span class=m>22</span>
<span class=nv>TUN_LOCAL</span><span class=o>=</span><span class=m>0</span>   <span class=c1># tun device number here.</span>
<span class=nv>TUN_REMOTE</span><span class=o>=</span><span class=m>0</span>  <span class=c1># tun device number there</span>
<span class=nv>IP_LOCAL</span><span class=o>=</span>192.168.111.2 <span class=c1># IP Address for tun here</span>
<span class=nv>IP_REMOTE</span><span class=o>=</span>192.168.111.1 <span class=c1># IP Address for tun there.</span>
<span class=nv>IP_MASK</span><span class=o>=</span><span class=m>30</span> <span class=c1># Mask of the ips above.</span>
<span class=nv>NET_REMOTE</span><span class=o>=</span>192.168.0.0/16 <span class=c1># Network on the other side of the tunnel</span>
<span class=nv>NET_LOCAL</span><span class=o>=</span>192.168.8.0/24  <span class=c1># Network on this side of the tunnel</span>
 
<span class=nb>echo</span> <span class=s2>&#34;Starting VPN tunnel ...&#34;</span>
modprobe tun
ssh -w <span class=si>${</span><span class=nv>TUN_LOCAL</span><span class=si>}</span>:<span class=si>${</span><span class=nv>TUN_REMOTE</span><span class=si>}</span> -f <span class=si>${</span><span class=nv>HOST</span><span class=si>}</span> -p <span class=si>${</span><span class=nv>HOST_PORT</span><span class=si>}</span> <span class=s2>&#34;\
</span><span class=s2>	ip addr add </span><span class=si>${</span><span class=nv>IP_REMOTE</span><span class=si>}</span><span class=s2>/</span><span class=si>${</span><span class=nv>IP_MASK</span><span class=si>}</span><span class=s2> dev tun</span><span class=si>${</span><span class=nv>TUN_REMOTE</span><span class=si>}</span><span class=s2> \
</span><span class=s2>	&amp;amp;&amp;amp; ip link set tun</span><span class=si>${</span><span class=nv>TUN_REMOTE</span><span class=si>}</span><span class=s2> up \
</span><span class=s2>	&amp;amp;&amp;amp; ip route add </span><span class=si>${</span><span class=nv>NET_LOCAL</span><span class=si>}</span><span class=s2> via </span><span class=si>${</span><span class=nv>IP_LOCAL</span><span class=si>}</span><span class=s2> \
</span><span class=s2>	&amp;amp;&amp;amp; true&#34;</span>
sleep <span class=m>3</span>
ip addr add <span class=si>${</span><span class=nv>IP_LOCAL</span><span class=si>}</span>/<span class=si>${</span><span class=nv>IP_MASK</span><span class=si>}</span> dev tun<span class=si>${</span><span class=nv>TUN_LOCAL</span><span class=si>}</span>
ip link <span class=nb>set</span> tun<span class=si>${</span><span class=nv>TUN_LOCAL</span><span class=si>}</span> up
ip route add <span class=si>${</span><span class=nv>NET_REMOTE</span><span class=si>}</span> via <span class=si>${</span><span class=nv>IP_REMOTE</span><span class=si>}</span>
<span class=nb>echo</span> <span class=s2>&#34;... done.&#34;</span>
</code></pre></div><p>You&rsquo;ll maybe want to run this as root, because of the &ldquo;ip&rdquo; commands, and so ;)</p>
<p>It&rsquo;s still far from perfect (i.e: the tunnel dies too often for some reason&mldr; although keep alive is set). But at least people around can print again! Luckily VoIP is handled out of the VPN.</p>
</div>
<div class=nav-left>
<a class=nav-item href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.marcfargas.com%2f2008%2f07%2fip-tunnel-over-ssh-with-tun%2f" title="Share on Facebook" target=_blank><span class="fa fa-facebook fa-2x" aria-hidden=true></span></a>
<a class=nav-item href="https://plus.google.com/share?url=https%3a%2f%2fwww.marcfargas.com%2f2008%2f07%2fip-tunnel-over-ssh-with-tun%2f" title="Share on Google+" target=_blank><span class="fa fa-google-plus fa-2x" aria-hidden=true></span></a>
<a class=nav-item href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.marcfargas.com%2f2008%2f07%2fip-tunnel-over-ssh-with-tun%2f" title="Share on LinkedIn" target=_blank><span class="fa fa-linkedin fa-2x" aria-hidden=true></span></a>
<a class=nav-item href="https://twitter.com/home?status=Ip%20Tunnel%20Over%20Ssh%20With%20Tun - https%3a%2f%2fwww.marcfargas.com%2f2008%2f07%2fip-tunnel-over-ssh-with-tun%2f" title="Tweet this" target=_blank><span class="fa fa-twitter fa-2x"></span></a>
<a class=nav-item href="http://www.reddit.com/submit?url=https%3a%2f%2fwww.marcfargas.com%2f2008%2f07%2fip-tunnel-over-ssh-with-tun%2f&title=Ip%20Tunnel%20Over%20Ssh%20With%20Tun" title="Share on Reddit" target=_blank><span class="fa fa-reddit-alien fa-2x" aria-hidden=true></span></a>
</div>
</div>
</section>
<section class=section>
<div class="container has-text-centered">
<p>&copy; 2021 | Follow on <a href=https://twitter.com/telenieko target=_blank>Twitter</a> | <a href=https://github.com/mgjohansen/hucore.git target=_blank>Hucore theme</a> & <a href=http://gohugo.io target=_blank>Hugo</a> â™¥</p>
</div>
</section>
<script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js integrity="sha256-+bhVTaRmJ/c07eV80nU8gD2cBBF0rYkf1txqXlrbvb0=" crossorigin=anonymous></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/go.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/python.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/bash.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/kotlin.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/java.min.js></script>
<script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>